#!/usr/bin/env bash

set -e

. /usr/local/share/myx.common/include/subr-freebsd.sh
UserRequireRoot



sysrc \
	postfix_enable=YES \ 
	sendmail_enable=NONE \
	sendmail_submit_enable=NO \
	sendmail_outbound_enable=NO \
	sendmail_msp_queue_enable=NO
	
sysrc sshd_enable="YES"
sysrc fsck_y_enable="YES"
sysrc named_enable="YES"
sysrc ntpdate_enable="YES"
sysrc ntpdate_flags="-b pool.ntp.org europe.pool.ntp.org time.euro.apple.com"

pkg install -y sudo bash nano screen curl postfix metamail rsync rlwrap elinks xtail xmlstarlet ncdu tinc mtr-nox11 p5-ack smartmontools cpuflags ipcalc trafshow host-setup sysrc openjdk8 bind911

fetch https://raw.githubusercontent.com/myx/os-myx.common-freebsd/master/sh-scripts/install-myx.common-freebsd.sh -o - | sh -e

myx.common setup/server --postfix-mta
myx.common lib/replaceLine /usr/local/etc/sudoers '^%wheel ALL=*' '%wheel ALL=(ALL) ALL'


# ACMBSDPATH=/usr/local/acmbsd
# SCRIPTNAME=acmbsd

myx.common lib/installUser acmbsd "ACMBSD pseudo-user" 191 "/usr/local/acmbsd"

mkdir -p /usr/local/acmbsd/.ssh
chown acmbsd:acmbsd /usr/local/acmbsd/.ssh
chmod 700 /usr/local/acmbsd/.ssh

echo -n Check for keys...
if [ ! -f "/usr/local/acmbsd/.ssh/id_rsa" -o ! -f "/usr/local/acmbsd/.ssh/id_rsa.pub" ]; then
   ssh-keygen -q -N "" -f /usr/local/acmbsd/.ssh/id_rsa -t rsa
   myx.common lib/out.status green CREATED
else
   myx.common lib/out.status green FOUND
fi

## Keeps SSH connection
myx.common lib/replaceLine /etc/ssh/sshd_config '^ClientAliveInterval *' 'ClientAliveInterval 60'
myx.common lib/replaceLine /etc/ssh/sshd_config '^ClientAliveCountMax *' 'ClientAliveCountMax 10'




echo "Not yet! BETA BETA BETA"



TMP_DIR="`mktemp -d`"

myx.common lib/fetchStdout https://github.com/acmcms/acm-install-freebsd/archive/master.tar.gz | \
 		tar zxvf - -C "$TMP_DIR" --include "*/sh-scripts/acmbsd/*" --strip-components 3

bash "$TMP_DIR/acmbsd.sh" "preparebsd"

rm -rf "$TMP_DIR"
